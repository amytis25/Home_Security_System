# Message Flow Examples\n\n## Example 1: User Clicks \"Lock Door\" Button\n\n```\n1. USER INTERACTION\n   └─ User clicks: \"Lock Door\" (D1 currently unlocked)\n\n2. WEB UI (web_control.js)\n   └─ toggleDoor(1) called\n   └─ state.lockLocked === false\n   └─ action = \"LOCK\"\n   └─ socket.emit('send-command', {\n        module: 'D1',\n        target: 'D0',\n        action: 'LOCK'\n      })\n   └─ Display: msg.textContent = 'Sending command...'\n\n3. SERVER (server.js)\n   └─ Receives 'send-command' event\n   └─ Forwards to door_server.sendCommand()\n\n4. UDP BRIDGE (door_server.js)\n   └─ cmdCounter = 42\n   └─ payload = \"D1 COMMAND 42 D0 LOCK\\n\"\n   └─ buffer = Buffer.from(payload)\n   └─ udpSocket.send(buffer, 0, ..., HUB_PORT, HUB_HOST)\n   └─ Registers pending callback: pending.set(42, { socket, timer })\n\n5. HUB (192.168.8.108:12345)\n   └─ Receives: D1 COMMAND 42 D0 LOCK\n   └─ Executes lock on D1\n   └─ Sends feedback: D1 FEEDBACK 42 D0 LOCKED\\n\n6. UDP BRIDGE (Receives Response)\n   └─ udpSocket.on('message', (msgBuf) => {\n        msg = \"D1 FEEDBACK 42 D0 LOCKED\"\n        parts = [\"D1\", \"FEEDBACK\", \"42\", \"D0\", \"LOCKED\"]\n        moduleId = \"D1\"\n        type = \"FEEDBACK\"\n        cmdid = 42\n        target = \"D0\"\n        action = \"LOCKED\"\n        \n        p = pending.get(42)  // Found!\n        p.socket.emit('command-feedback', {\n          module: \"D1\",\n          cmdid: 42,\n          target: \"D0\",\n          action: \"LOCKED\"\n        })\n        clearTimeout(p.timer)\n        pending.delete(42)\n      })\n\n7. WEB UI (web_control.js)\n   └─ socket.on('command-feedback', (data) => {\n        moduleId = \"D1\"\n        action = \"LOCKED\"\n        parts = [\"LOCKED\"]\n        doorStates['D1'].lockLocked = true\n        updateUIForModule('D1')\n      })\n\n8. UI UPDATE\n   └─ doorStates['D1'] = {\n        doorOpen: false,\n        lockLocked: true,\n        moduleId: 'D1'\n      }\n   └─ span#door1_status.textContent = 'closed / locked'\n   └─ btn#toggle_door1.textContent = 'Unlock Door'\n   └─ btn#toggle_door1.disabled = false\n   └─ msg#door1_message.textContent = ''  // After 2 second timeout\n```\n\n## Example 2: Hub Sends Unsolicited Event (Door Opened)\n\n```\n1. HUB EVENT\n   └─ Someone physically opens door D2\n   └─ Hub sends: D2 EVENT D0 DOOR OPEN\\n\n2. UDP BRIDGE (Receives)\n   └─ msg = \"D2 EVENT D0 DOOR OPEN\"\n   └─ parts = [\"D2\", \"EVENT\", \"D0\", \"DOOR\", \"OPEN\"]\n   └─ moduleId = \"D2\"\n   └─ type = \"EVENT\"\n   └─ target = \"D0\"\n   └─ event = \"DOOR OPEN\"\n   \n   └─ NOT in pending map (unsolicited)\n   └─ io.sockets.emit('hub-event', {\n        module: \"D2\",\n        type: \"EVENT\",\n        target: \"D0\",\n        event: \"DOOR OPEN\",\n        raw: \"D2 EVENT D0 DOOR OPEN\"\n      })\n   └─ Broadcast to ALL connected clients\n\n3. WEB UI (web_control.js) - ALL TABS\n   └─ socket.on('hub-event', (data) => {\n        moduleId = \"D2\"\n        eventStr = \"DOOR OPEN\"\n        \n        if (eventStr.includes('OPEN')) {\n          doorStates['D2'].doorOpen = true\n        }\n        updateUIForModule('D2')\n      })\n\n4. UI UPDATE (All Tabs)\n   └─ doorStates['D2'] = {\n        doorOpen: true,\n        lockLocked: (unchanged),\n        moduleId: 'D2'\n      }\n   └─ span#door2_status.textContent = 'open / locked'\n   └─ btn#toggle_door2.textContent = 'Cannot lock open door'\n   └─ btn#toggle_door2.disabled = true\n```\n\n## Example 3: Periodic Status Poll\n\n```\nEVERY 2 SECONDS (from setInterval)\n\n1. WEB UI (web_control.js)\n   └─ requestModuleStatus('D1')\n   └─ requestModuleStatus('D2')\n   └─ requestModuleStatus('D3')\n   └─ Three simultaneous socket.emit('send-command', {\n        module: 'D1',\n        target: 'D0',\n        action: 'STATUS'\n      })\n\n2. UDP BRIDGE (door_server.js)\n   └─ cmdCounter = 43, 44, 45\n   └─ Send three UDP packets:\n      - \"D1 COMMAND 43 D0 STATUS\\n\"\n      - \"D2 COMMAND 44 D0 STATUS\\n\"\n      - \"D3 COMMAND 45 D0 STATUS\\n\"\n   └─ Register three pending callbacks\n\n3. HUB (Processes all three)\n   └─ Sends responses:\n      - \"D1 FEEDBACK 43 D0 CLOSED,UNLOCKED\\n\"\n      - \"D2 FEEDBACK 44 D0 OPEN,LOCKED\\n\"\n      - \"D3 FEEDBACK 45 D0 CLOSED,LOCKED\\n\"\n\n4. UDP BRIDGE (Receives all responses)\n   └─ Processes in order received, routes to originating client\n   └─ For each FEEDBACK: find pending[cmdid], emit 'command-feedback'\n\n5. WEB UI (web_control.js)\n   └─ socket.on('command-feedback') called 3x\n   └─ Updates doorStates for D1, D2, D3\n   └─ Calls updateUIForModule for each\n\n6. UI UPDATE\n   └─ All three door statuses refresh\n   └─ D1: closed / unlocked\n   └─ D2: open / locked        ← Cannot lock, button disabled\n   └─ D3: closed / locked\n```\n\n## Example 4: Timeout Error (Hub Not Responding)\n\n```\n1. USER CLICKS LOCK BUTTON (D1)\n   └─ socket.emit('send-command', {\n        module: 'D1',\n        target: 'D0',\n        action: 'LOCK'\n      })\n\n2. UDP BRIDGE (Sends command)\n   └─ udpSocket.send(...HUB_HOST...)\n   └─ cmdid = 50\n   └─ Sets 1500ms timeout:\n      setTimeout(() => {\n        pending.delete(50)\n        socket.emit('command-error', {\n          module: 'D1',\n          cmdid: 50,\n          error: 'No FEEDBACK from hub'\n        })\n      }, 1500)\n\n3. TIMEOUT OCCURS (Hub didn't respond)\n   └─ Timer fires after 1500ms\n   └─ Sends 'command-error' event\n\n4. WEB UI (web_control.js)\n   └─ socket.on('command-error', (data) => {\n        moduleNum = \"1\"\n        msg = document.getElementById('door1_message')\n        msg.textContent = \"Error: No FEEDBACK from hub\"\n        setTimeout(() => {\n          msg.textContent = ''\n        }, 3000)\n      })\n\n5. UI UPDATE\n   └─ Red error message appears: \"Error: No FEEDBACK from hub\"\n   └─ Message disappears after 3 seconds\n   └─ Door state remains unchanged from cache\n```\n\n## Message Timeline for Multi-Door Control\n\n```\nTIME    D1              D2              D3              Server\n────────────────────────────────────────────────────────────\n0ms     Lock click ─────────────────────────────────────\n                                                ↓\n                                        send-command D1\n                                        ↓\n20ms    ──────────────────────────────────────────────────\n        User opens D2 ────────────────────────────────────\n        (physical action)                  (hub event)\n                                        ↓\n                                    hub-event D2 OPEN\n50ms    ↓ D1 locked                    ↓ D2 open       ↓\n        received in web-control     received in         auto-refresh\n        state update                 web-control       REQUEST STATUS\n                                     state update         all 3 doors\n        D1: locked ✓                 D2: open ✗\n        cannot lock                  D3: ? (pending)\n\n100ms   ────────────────────────────────────────────────\n                                                ↓\n                                    Receive feedback\n                                    D1, D2, D3 STATUS\n\n150ms   ↓ Update UI                  ↓ Update UI      ↓ Update UI\n        D1: closed/locked           D2: open/locked  D3: closed/unlocked\n\n2000ms  ────────────────────────────────────────────────\n        ↑ REQUEST STATUS (2-sec poll)\n        └─ D1, D2, D3 STATUS\n```\n\n## Connection States\n\n### Connected (Normal)\n```\nHub alive → sends responses/events → UI updates in real-time\n```\n\n### Disconnected (Hub offline)\n```\nHub dead → no responses → timeouts → command-error events\n→ UI shows errors → door states remain cached\n```\n\n### Reconnect (Hub comes back online)\n```\nFirst 'send-command' after reconnect:\n→ UDP send succeeds\n→ Hub responds\n→ UI updates\n→ Back to normal operation\n```\n\n## Multi-Tab Synchronization\n\n```\nTAB 1                   SERVER                  TAB 2\n─────────────────────────────────────────────────────\nLock click D1 ──────→ send to hub\n                        ↓\n                    hub-event received\n                        ↓\n                   io.sockets.emit()\n                   (broadcast to all)\n                        ↓\nReceive update  ←────────┴────────→ Receive update\nD1 now locked          (TAB 2 sees the change too!)\n```\n\nBoth tabs show \"D1: closed/locked\" even though user only clicked in TAB 1.\n"